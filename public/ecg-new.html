<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Micro ECG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background: #f4f4f9;
            color: #333;
        }
        button , input{
            padding: 3px 9px;
            margin: 5px;
            background-color: #f4f4f9;
            border: 0.1px solid #00f;
            box-shadow: 2px 2px 2px gray;
        }
        button:hover , input:hover{
           box-shadow: none;
        }
        .pushButton[active]{
            background-color: #0f05;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            padding: 10px 0;
            border-bottom: 2px solid #e0e0e0;
        }
        .header h1 {
            font-size: 2rem;
            color: #007bff;
        }
        .snap-container{
            width: 100%;
            margin: auto;
        }
        .canvas-container {
            margin-top: 20px;
            text-align: center;
            position: sticky; 
            top: 0px;
            pointer-events: none;
            background-color: #fff5;
        }
        canvas, .snap-container img {
            border: 1px solid #ddd;
            width: 100%;
            height: 100px;
        }
        .tabs{
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tabs button {
            margin: 0px;
            flex: 1 1 auto;
        }
        .tabs button[active] {
            box-shadow: none;
            border: none;
        }
        .tab-contents>div:not([active]) {
            display: none;
        }
        .parameters {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px 0;
        }
        .parameter {
            flex: 1 1 auto;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 30%;
        }
        .parameter span {
            font-size: 1rem;
            color: #555;
            font-weight: bold;
            white-space: nowrap;
        }
        .controls , .settings, .flexbox{
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .control , .flexbox div, .setting{
            flex: 1 1 auto;
            text-align: center;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .ai-assistant {
            margin: 20px 0;
            background: #e7f5ff;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .ai-assistant h2 {
            font-size: 1.5rem;
            color: #00f;
        }
        .ai-assistant p {
            font-size: 1rem;
            color: #444;
            margin-top: 10px;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.7rem;
            color: #333;
        }
        .danger {
            color: red!important;
            border-color: red!important;
        }
        @media (max-width: 668px) {
            .parameters {
                flex-direction: column;
            }
            .flexbox{
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <noscript>
        Please Enable JavaScript in your browser...!!
    </noscript>
    <div class="container">
        <div class="header">
            <h1>Micro ECG &hearts;(Alpha)</h1>
        </div>
        <div id="snap-container" class="snap-container"></div>
        <div class="canvas-container">
            <canvas id="ecgCanvas"></canvas>
        </div>
        <div class="tabs">
            <button active data-id="parameters">PARAMETERS</button>
            <button data-id="ai-assistant">AI</button>
            <button data-id="controls">CONTROLS</button>
            <button data-id="recordings">RECORDINGS</button>
            <button data-id="settings" disabled>SETTINGS</button>
        </div>
        <div class="tab-contents">
            <div active class="parameters">
                <div class="parameter">
                    <span>Result: <span id="param-result"> •_° </span> </span>
                </div>
                <div class="parameter">
                    <span>Heart Rate: <span id="param-hr"> •_° </span> bpm</span>
                </div>
                <div class="parameter">
                    <span>QRS Duration: <span id="param-qrs"> •_° </span> ms</span>
                </div>
                <div class="parameter">
                    <span>QT Interval: <span id="param-qt"> •_° </span> ms</span>
                </div>
                <div class="parameter">
                    <span>PR Interval: <span id="param-pr"> •_° </span> ms</span>
                </div>
                <div class="parameter">
                   <span> ST Interval: <span id="param-st"> •_° </span> ms </span>
                </div>
            </div>
            <div class="ai-assistant">
                <h2>AI Assistant</h2>
                <p id="ai-output"></p>
                <button id="ai-assistBtn">&#x27F3; Get Assistance</button>
            </div>
            <div class="controls">
                <div style="width:100%" class="control"></div>
                <div class="control pushButton" data-toggle="isHold">
                    <span>HOLD</span>
                </div>
                <div id="recordBtn" class="control pushButton">
                    <span>RECORD</span>
                </div>
                <div class="control" onclick="data_plot = []">
                    <span>CLEAR</span>
                </div>
                <div id="takeSnapBtn" class="control">
                    <span>SNAP</span>
                </div>
                <div style="width:100%" class="control"></div>
                <div class="control">
                    <span>TIME/DIV</span><br /> &minus; <input class="multiturn minZero" type="range" oninput="scale.x = this.dataset.value/10" min="0" max="100" data-default="50" value="50"/> &plus;
                </div>
                <div class="control">
                    <span>VOLT/DIV</span><br /> &minus; <input class="multiturn" type="range" oninput="scale.y = this.dataset.value/10" min="0" max="100" data-default="120" value="50"/> &plus;
                </div>
                <div class="control">
                    <span>POSITION VERTICAL</span><br /> &#9650; <input class="multiturn" type="range" oninput="move.y = this.dataset.value*10" min="0" max="100" data-default="13" value="50"/> &#9660;
                </div>
                <div class="control">
                    <span>POSITION HORIZONTAL</span><br /> &#9198; <input class="multiturn minZero" type="range" oninput="move.x = this.dataset.value*10" min="0" max="100" data-default="0" value="50"/> &#9197;
                </div>
                <div style="width:100%" class="control"></div>
            </div>
            <div class="flexbox recordings">
                <div style="width:100%" class="flexbox"><label for="">IMPORT(.json)</label><input id="recordingImport" type="file" accept=".json"/></div>
                <div id="recordings" class="flexbox">
                    <div class="flexbox">
                        <div class="pushButton">NO RECORD FOUND<br /><sub>mm:hh dd-mm-yyyy</sub></div>
                        <div class="download">&#x2913;</div>
                        <div class="download">x</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <a href="#" onclick="window.open('/','_blank)">Open in External Browser(Android Only)</a>
            <p style="display:block;background-color:#eee;"><b>Disclaimer:</b> The project is not designed nor certified to diagnose any serious problem.
            We, the creators, developers, and distributors of this App/Website/device are not liable for any inaccuracies, misinterpretations, or adverse outcomes resulting from its use. Use of the App/Website/device is at your own risk and discretion.</p>
        </div>
    </div>
    
    
    <script type="text/javascript" charset="utf-8">
        // --- Sample Data // Remove on deployment --- //
        var data_plot = [1893, 1902, 1880, 1872, 1869, 1866, 1861, 1856, 1853, 1855, 1855, 1856, 1853, 1831, 1853, 1850, 1847, 1855, 1851, 1856, 1858, 1863, 1857, 1860, 1857, 1862, 1862, 1858, 1858, 1866, 1858, 1856, 1852, 1847, 1843, 1847, 1859, 1856, 1854, 1853, 1842, 1843, 1845, 1849, 1846, 1847, 1850, 1845, 1842, 1843, 1842, 1847, 1849, 1846, 1850, 1852, 1855, 1848, 1849, 1846, 1854, 1850, 1849, 1815, 1851, 1857, 1859, 1870, 1877, 1879, 1874, 1872, 1862, 1849, 1856, 1847, 1846, 1858, 1862, 1870, 1871, 1883, 1879, 1878, 1872, 1869, 1866, 1872, 1872, 1872, 1874, 1885, 1881, 1873, 1875, 1881, 1885, 1882, 1883, 1885, 1883, 1883, 1874, 1870, 1872, 1871, 1872, 1873, 1875, 1872, 1871, 1871, 1867, 1824, 1868, 1867, 1868, 1871, 1875, 1877, 1881, 1885, 1887, 1885, 1886, 1882, 1883, 1882, 1886, 1886, 1878, 1875, 1874, 1877, 1875, 1880, 1879, 1882, 1877, 1888, 1891, 1898, 1893, 1887, 1890, 1888, 1890, 1890, 1891, 1899, 1895, 1899, 1902, 1910, 1923, 1932, 1935, 1937, 1937, 1935, 1933, 1936, 1946, 1904, 1942, 1937, 1931, 1920, 1925, 1924, 1922, 1926, 1927, 1929, 1923, 1922, 1918, 1908, 1891, 1881, 1872, 1871, 1875, 1877, 1885, 1889, 1898, 1904, 1902, 1895, 1898, 1893, 1910, 1911, 1910, 1911, 1904, 1904, 1901, 1904, 1904, 1904, 1914, 1917, 1914, 1903, 1898, 1902, 1904, 1910, 1909, 1913, 1886, 1947, 1984, 2034, 2113, 2210, 2320, 2435, 2558, 2669, 2723, 2700, 2604, 2431, 2227, 2027, 1867, 1763, 1723, 1728, 1762, 1810, 1867, 1919, 1950, 1964, 1966, 1950, 1936, 1925, 1909, 1903, 1894, 1887, 1898, 1893, 1891, 1886, 1879, 1879, 1882, 1878, 1876, 1885, 1892, 1890, 1893, 1892, 1888, 1882, 1845, 1887, 1897, 1899, 1895, 1886, 1888, 1886, 1886, 1888, 1899, 1904, 1906, 1911, 1913, 1908, 1907, 1904, 1907, 1913, 1918, 1917, 1911, 1917, 1915, 1920, 1918, 1908, 1906, 1917, 1927, 1936, 1938, 1943, 1947, 1948, 1937, 1940, 1945, 1939, 1942, 1943, 1950, 1942, 1946, 1946, 1947, 1949, 1957, 1970, 1970, 1979, 1984, 1978, 1979, 1983, 1984, 1991, 1994, 1998, 2000, 2002, 2009, 2018, 2027, 2028, 2032, 2039, 2047, 2064, 2065, 2069, 2069, 2069, 2070, 2075, 2075, 2077, 2085, 2089, 2106, 2113, 2119, 2117, 2109, 2108, 2098, 2095, 2092, 2093, 2085, 2077, 2067, 2061, 2039, 2031, 2021, 2016, 2008, 1996, 1972, 1968, 1959, 1953, 1948, 1936, 1946, 1937, 1933, 1922, 1917, 1917, 1904, 1898, 1901, 1900, 1899, 1899, 1893, 1892, 1890, 1885, 1887, 1894, 1901, 1899, 1900, 1888, 1886, 1883, 1874, 1882, 1882, 1881, 1889, 1890, 1888, 1893, 1887, 1882, 1877, 1874, 1882, 1886, 1889, 1891, 1895, 1888, 1889, 1889, 1886, 1887, 1886, 1879, 1876, 1874, 1878, 1885, 1889, 1892, 1891, 1885, 1882, 1879, 1890, 1889, 1904, 1900, 1906, 1906, 1904, 1904, 1903, 1903, 1895, 1891, 1906, 1905, 1904, 1902, 1904, 1907, 1916, 1915, 1911, 1916, 1916, 1919, 1910, 1903, 1904, 1902, 1899, 1900, 1904, 1904, 1901, 1898, 1890, 1876, 1894, 1899, 1901, 1902, 1896, 1895, 1899, 1902, 1904, 1900, 1898, 1899, 1901, 1903, 1902, 1898, 1904, 1902, 1901, 1904, 1904, 1905, 1899, 1891, 1892, 1892, 1894, 1898, 1895, 1904, 1904, 1913, 1920, 1917, 1914, 1917, 1920, 1921, 1919, 1926, 1935, 1939, 1952, 1953, 1959, 1967, 1960, 1951, 1947, 1903, 1937, 1923, 1936, 1936, 1939, 1934, 1924, 1905, 1897, 1890, 1882, 1879, 1872, 1876, 1878, 1885, 1878, 1879, 1881, 1883, 1886, 1889, 1890, 1888, 1887, 1882, 1884, 1889, 1902, 1902, 1899, 1890, 1889, 1882, 1879, 1882, 1889, 1896, 1899, 1900, 1894, 1890, 1889, 1895, 1896, 1914, 1936, 1985, 2059, 2103, 2237, 2347, 2470, 2599, 2688, 2713, 2653, 2518, 2338, 2143, 1959, 1811, 1728, 1709, 1722, 1773, 1827, 1873, 1910, 1936, 1940, 1945, 1942, 1933, 1917, 1904, 1893, 1887, 1883, 1887, 1888, 1889, 1883, 1872, 1872, 1872, 1861, 1859, 1859, 1872, 1881, 1888, 1887, 1887, 1885, 1884, 1886, 1881, 1858, 1857, 1847, 1840, 1833, 1830, 1830, 1820, 1824, 1825, 1819, 1826, 1827, 1831, 1823, 1823, 1820, 1825, 1837, 1843, 1854, 1863, 1865, 1862, 1855, 1849, 1849, 1851, 1850, 1853, 1859, 1871, 1884, 1881, 1877, 1883, 1879, 1883, 1888, 1886, 1885, 1879, 1888, 1890, 1898, 1898, 1904, 1909, 1913, 1907, 1871, 1922, 1919, 1913, 1915, 1920, 1917, 1931, 1936, 1939, 1952, 1953, 1959, 1967, 1975, 1984, 1983, 1981, 1977, 1982, 1972, 1968, 1969, 1969, 1978, 1988, 2000, 2007, 2014, 2021, 2023, 2019, 2011, 2006, 2001, 1999, 1987, 1982, 1966, 1955, 1955, 1945, 1936, 1923, 1913, 1904, 1894, 1882, 1872, 1872, 1863, 1863, 1854, 1840, 1840, 1836, 1840, 1841, 1842, 1837, 1835, 1826, 1822, 1823, 1829, 1835, 1830, 1825, 1814, 1807, 1809, 1811, 1815, 1818, 1819, 1822, 1823, 1824, 1811, 1808, 1808, 1817, 1826, 1832, 1825, 1833, 1828, 1829, 1834, 1838, 1835, 1834, 1827, 1826, 1831, 1836, 1838, 1840, 1842, 1842, 1842, 1853, 1843, 1841, 1845, 1845, 1842, 1841, 1852, 1855, 1863, 1867, 1867, 1866, 1863, 1862, 1858, 1863, 1862, 1869, 1867, 1863, 1862, 1857, 1863, 1872, 1870, 1870, 1867, 1868, 1872, 1873, 1872, 1871, 1872, 1874, 1872, 1872, 1870, 1859, 1861, 1869, 1872, 1872, 1863, 1865, 1872, 1878, 1885, 1884, 1881, 1882, 1885, 1885, 1885, 1881, 1878, 1879, 1877, 1879, 1882, 1889, 1893, 1902, 1904, 1892, 1885, 1890, 1890, 1898, 1895, 1899, 1903, 1901, 1895, 1891, 1895, 1898, 1898, 1899, 1904, 1906, 1912, 1909, 1907, 1906, 1909, 1915, 1918, 1910, 1907, 1908, 1910, 1910, 1916, 1913, 1920, 1923, 1929, 1889, 1931, 1925, 1935, 1939, 1939, 1943, 1942, 1950, 1936, 1947, 1948, 1951, 1957, 1969, 1974, 1971, 1968, 1962, 1961, 1954, 1955, 1958, 1958, 1965, 1965, 1967, 1967, 1960, 1953, 1935, 1919, 1907, 1905, 1901, 1901, 1900, 1901, 1904, 1904, 1911, 1916, 1917, 1917, 1919, 1919, 1915, 1909, 1911, 1909, 1897, 1915, 1907, 1910, 1906, 1914, 1919, 1920, 1917, 1923, 1927, 1925, 1925, 1917, 1910, 1914, 1939, 1988, 2054, 2133, 2231, 2350, 2465, 2583, 2675, 2713, 2701, 2610, 2449, 2273, 2084, 1936, 1833, 1786, 1776, 1811, 1869, 1915, 1953, 1978, 1983, 1977, 1965, 1950, 1946, 1936, 1929, 1919, 1917, 1921, 1904, 1907, 1904, 1911, 1918, 1930, 1929, 1929, 1923, 1923, 1920, 1914, 1911, 1913, 1913, 1922, 1935, 1939, 1946, 1936, 1936, 1938, 1939, 1936, 1936, 1936, 1931, 1931, 1927, 1931, 1930, 1930, 1936, 1936, 1936, 1941, 1951, 1952, 1957, 1959, 1967, 1965, 1955, 1951, 1952, 1945, 1943, 1952, 1965, 1951, 1984, 1983, 1971, 1969, 1969, 1972, 1972, 1980, 1985, 1997, 1991, 1991, 1989, 1985, 1989, 1987, 1985, 1995, 2000, 2007, 2016, 2027, 2023, 2027, 2027, 2029, 2031, 2034, 2032, 2032, 2032, 2034, 2033, 2030, 2032, 2043, 2058, 2059, 2069, 2070, 2081, 2084, 2085, 2092, 2094, 2093, 2086, 2089, 2091, 2059, 2080, 2079, 2073, 2064, 2063, 2059, 2046, 2042, 2037, 2027, 2014, 1996, 1983, 1975, 1968, 1967, 1966, 1958, 1951, 1940, 1934, 1931, 1925, 1922, 1915, 1907, 1897, 1887, 1893, 1895, 1899, 1902, 1903, 1901, 1901, 1898, 1902, 1893, 1898, 1901, 1899, 1895, 1894, 1892, 1891, 1889, 1890, 1890, 1890, 1855, 1886, 1887, 1889, 1891, 1892, 1897, 1899, 1903, 1904, 1904, 1898, 1881, 1870, 1869, 1872, 1884, 1891, 1895, 1894, 1895, 1895, 1901, 1898, 1893, 1895, 1895, 1893, 1887, 1886, 1885, 1885, 1889, 1893, 1895, 1899, 1897, 1893, 1894, 1890, 1884, 1882, 1883, 1886, 1892, 1895, 1891, 1891, 1895, 1900, 1900, 1899, 1901, 1896, 1901, 1904, 1904, 1907, 1904, 1905, 1911, 1925, 1913, 1907, 1904, 1904, 1904, 1909, 1921, 1929, 1926, 1920, 1915, 1915, 1914, 1911, 1914, 1918, 1921, 1923, 1922, 1923, 1920, 1918, 1911, 1910, 1920, 1926, 1923, 1929, 1923, 1927, 1927, 1927, 1931, 1923, 1923, 1931, 1938, 1936, 1933, 1927, 1922, 1923, 1930, 1936, 1936, 1935, 1933, 1929, 1922, 1917, 1919, 1909, 1919, 1923, 1935, 1931, 1927, 1934, 1933, 1933, 1925, 1923, 1922, 1923, 1936, 1936, 1939, 1939, 1938, 1941, 1942, 1942, 1951, 1954, 1952, 1955, 1958, 1966, 1966, 1968, 1968, 1977, 1979, 1981, 1978, 1984, 1989, 1957, 1978, 1975, 1968, 1968, 1968, 1972, 1981, 1976, 1974, 1966, 1961, 1955, 1945, 1937, 1935, 1926, 1922, 1921, 1921, 1917, 1922, 1922, 1917, 1917, 1923, 1926, 1930, 1923, 1920, 1919, 1917, 1919, 1918, 1919, 1918, 1920, 1915, 1914, 1920, 1922, 1922, 1919, 1918, 1923, 1918, 1918, 1919, 1929, 1955, 1974, 2077, 2138, 2224, 2320, 2423, 2519, 2613, 2665, 2661, 2593, 2464, 2302, 2135, 1975, 1873, 1821, 1811, 1841, 1885, 1923, 1959, 1973, 1979, 1969, 1949, 1936, 1919, 1897, 1899, 1898, 1899, 1902, 1904, 1909, 1909, 1909, 1905, 1895, 1898, 1898, 1891, 1888, 1891, 1895, 1897, 1902, 1904, 1905, 1908, 1888, 1908, 1910, 1905, 1909, 1909, 1917, 1915, 1919, 1920, 1922, 1922, 1923, 1931, 1933, 1934, 1936, 1936, 1935, 1936, 1937, 1941, 1942, 1941, 1949, 1947, 1949, 1950, 1955, 1961, 1968, 1968, 1968, 1968, 1967, 1968, 1969, 1969, 1968, 1973, 1975, 1981, 1987, 1990, 1989, 1984, 1985, 1989, 1985, 1949, 1994, 2000, 2011, 2017, 2023, 2032, 2032, 2039, 2032, 2032, 2033, 2032, 2032, 2027, 2026, 2032, 2044, 2054, 2063, 2065, 2069, 2074, 2074, 2075, 2079, 2083, 2083, 2085, 2087, 2087, 2087, 2096, 2094, 2090, 2080, 2075, 2063, 2055, 2039, 2034, 2031, 2030, 2025, 2014, 2012, 2000, 1978, 1967, 1959, 1923, 1945, 1940, 1937, 1933, 1921, 1909, 1903, 1904, 1904, 1904, 1904, 1904, 1905, 1904, 1904, 1897, 1891, 1883, 1878, 1874, 1875, 1875, 1883, 1887, 1883, 1882, 1884, 1883, 1877, 1878, 1882, 1885, 1889, 1884, 1876, 1874, 1878, 1879, 1886, 1885, 1879, 1873, 1875, 1874, 1873, 1878, 1891, 1898, 1899, 1885, 1896, 1889, 1883, 1883, 1887, 1892, 1898, 1898, 1901, 1905, 1905, 1904, 1903, 1901, 1901, 1904, 1898, 1887, 1889, 1891, 1903, 1905, 1907, 1902, 1890, 1877, 1888, 1886, 1889, 1889, 1904, 1905, 1910, 1917, 1904, 1904, 1898, 1901, 1903, 1902, 1904, 1905, 1910, 1911, 1913, 1916, 1919, 1921, 1922, 1917, 1920, 1913, 1910, 1909, 1906, 1895, 1902, 1907, 1910, 1914, 1923, 1927, 1924, 1919, 1910, 1905, 1904, 1904, 1904, 1909, 1911, 1911, 1909, 1918, 1919, 1925, 1925, 1926, 1927, 1927, 1922, 1924, 1919, 1915, 1918, 1915, 1917, 1917, 1918, 1918, 1919, 1923, 1918, 1922, 1925, 1921, 1918, 1919, 1913, 1909, 1917, 1914, 1914, 1916, 1921, 1919, 1923, 1924, 1918, 1910, 1906, 1905, 1913, 1919, 1920, 1916, 1917, 1920, 1921, 1920, 1923, 1931, 1934, 1946, 1937, 1936, 1935, 1935, 1936, 1936, 1939, 1939, 1940, 1942, 1948, 1947, 1953, 1957, 1955, 1962, 1968, 1980, 1996, 2000, 1994, 1992, 1986, 1978, 1941, 1968, 1968, 1968, 1968, 1972, 1968, 1959, 1949, 1949, 1943, 1935, 1931, 1926, 1918, 1919, 1920, 1924, 1925, 1927, 1926, 1937, 1935, 1936, 1936, 1937, 1937, 1940, 1942, 1939, 1936, 1938, 1936, 1941, 1947, 1943, 1939, 1936, 1936, 1936, 1934, 1931, 1937, 1949, 1983, 2027, 2096, 2169, 2259, 2361, 2420, 2557, 2641, 2691, 2677, 2599, 2464, 2305, 2142, 1995, 1902, 1855, 1850, 1871, 1904, 1946, 1981, 1992, 1987, 1982, 1973, 1968, 1964, 1954, 1946, 1940, 1929, 1917, 1915, 1920, 1925, 1933, 1931, 1936, 1935, 1931, 1921, 1924, 1919, 1915, 1915, 1923, 1930, 1929, 1930, 1936, 1941, 1949, 1951, 1942, 1888, 1936, 1938, 1941, 1943, 1945, 1943, 1946, 1945, 1949, 1951, 1950, 1953, 1950, 1955, 1952, 1958, 1955, 1954, 1957, 1961, 1965, 1968, 1973, 1975, 1969, 1970, 1968, 1967, 1968, 1970, 1974, 1981, 1983, 1986, 1989, 1985, 1984, 1982, 1987, 1984, 1988, 1988, 1999, 2001, 2001, 2006, 2006, 2010, 2010, 2017, 2022, 2026, 2034, 2039, 2043, 2039, 2039, 2035, 2032, 2037, 2047, 2061, 2063, 2062, 2064, 2065, 2071, 2080, 2078, 2077, 2084, 2083, 2084, 2084, 2090, 2093, 2087, 2079, 2082, 2077, 2065, 2061, 2058, 2046, 2035, 2032, 2025, 2016, 2000, 1998, 1990, 1979, 1982, 1978, 1968, 1953, 1936, 1931, 1898, 1923, 1918, 1914, 1905, 1904, 1905, 1904, 1904, 1899, 1899, 1903, 1902, 1899, 1883, 1882, 1882, 1888, 1890, 1891, 1894, 1892, 1898, 1899, 1890, 1894, 1886, 1887, 1893, 1894, 1895, 1889, 1887, 1888, 1893, 1897, 1898, 1898, 1895, 1898, 1899, 1898, 1904, 1904, 1904, 1904, 1898, 1904, 1900, 1899, 1888, 1904, 1900, 1892, 1899, 1901, 1905, 1906, 1904, 1905, 1905, 1905, 1906, 1906, 1910, 1910, 1910, 1907, 1904, 1909, 1914, 1919, 1922, 1922, 1920, 1914, 1905, 1900, 1901, 1902, 1903, 1914, 1917, 1918, 1922, 1925, 1929, 1934, 1933, 1927, 1917, 1910, 1905, 1907, 1906, 1915, 1916, 1910, 1907, 1910, 1901, 1910, 1917, 1916, 1918, 1921, 1924, 1926, 1918, 1914, 1914, 1914, 1915, 1920, 1923, 1926, 1936, 1941, 1936, 1930, 1919, 1916, 1915, 1917, 1920, 1929, 1935, 1934, 1933, 1935, 1933, 1930, 1935, 1937, 1936, 1936, 1935, 1932, 1925, 1923, 1925, 1922, 1929, 1931, 1933, 1933]
    </script>
    
    <script type="text/javascript" charset="utf-8">
        // --- HELPERS --- //
        document.querySelectorAll(".pushButton").forEach(o => {
            o.addEventListener('click', (e) => {
                o.hasAttribute('active') ? o.removeAttribute('active'):o.setAttribute('active','');
                window[o.dataset.toggle] = o.hasAttribute('active');
                //window[o.dataset.toggle] || e.stopPropagation();
            },true)
        });
        
        document.querySelectorAll('.multiturn').forEach(o=> {
            let disp = Number(o.dataset.default);
            const max = Number(o.max);
            const min = Number(o.min);
        
            o.addEventListener('change', () => {
                if (o.value <= min && !(o.classList.contains('minZero') && disp <= 0)) {
                    o.value = max/2;
                    disp -= max/2
                }
                if (o.value >= max) {
                    o.value = max/2;
                    disp += max/2
                }
            });
            o.addEventListener('input', () => {
                if(o.classList.contains('minZero') && disp + Number(o.value-(max/2))  <= 0) return 0;
                o.dataset.value = disp + Number(o.value-(max/2));
            });
        });
        
        // ---- Custom alert and prompt ----//
       (() => {
          const a = document.createElement("div");
          a.style = "position:fixed;top:0;left:0;width:100%;height:100%;background:#0005;display:flex;justify-content:center;align-items:center;visibility:hidden;z-index:1000;";
        
          const b = document.createElement("div");
          b.style = "background:white;padding:20px;border-radius:5px;text-align:center;box-shadow:0 2px 5px rgba(0,0,0,0.3);width:250px;";
        
          const c = document.createElement("p");
          const d = document.createElement("input");
          d.type = "text";
          d.style = "display:none;margin-bottom:15px;padding:5px;width:100%;";
        
          const e = document.createElement("button");
          e.textContent = "OK";
          e.style = "background:#007bff;color:white;";
        
          const f = document.createElement("button");
          f.textContent = "Cancel";
          f.style = "background:#dc3545;color:white;display:none;";
        
          b.append(c, d, e, f);
          a.appendChild(b);
          document.body.appendChild(a);
        
          window.alert = msg => { c.textContent = msg; d.style.display = "none"; f.style.display = "none"; e.onclick = () => a.style.visibility = "hidden"; a.style.visibility = "visible"; };
          window.prompt = (msg, cb=(o=>{return false}),cc=(o=>{return false})) => { c.textContent = msg; d.style.display = "block"; f.style.display = "inline-block"; d.value = ""; e.onclick = () => { a.style.visibility = "hidden"; cb(d.value); }; f.onclick = () => {a.style.visibility = "hidden";cc(); }; a.style.visibility = "visible"; };
        })();
        
        // ---- Custom Notification ----//
        (() => {
            document.head.appendChild(Object.assign(document.createElement('style'), { innerHTML: `
                .notify-container {
                    width: 100%; max-height: 230px; overflow: scroll; display: flex; flex-direction: column;
                    align-items: center; position: fixed; top: 10px; left: 0; pointer-events: none;
                }
                .notify-container > div {
                    max-width: 400px; margin: 10px; border-radius: 5px; text-align: center; padding: 10px 20px;
                    background: #eef; color: #00f; position: relative; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                    transition: transform 0.5s; pointer-events: auto;
                }
                .notify-container > div:hover { transform: translateY(10%); }
                .notifyClose { position: absolute; right: 5px; bottom: 25%; font-weight: bold; cursor: pointer; }
            `}));
        
            let container = document.body.appendChild(Object.assign(document.createElement('div'), { className: "notify-container" }));
        
            document.notify = (t = '', c, s) => {
                let div = Object.assign(document.createElement('div'), { innerText: t });
                div.appendChild(Object.assign(document.createElement('div'), { className: "notifyClose", innerText: "×", onclick: () => div.remove() }));
                div.style = { error: 'background:#fdd;color:#f00;', warning: 'background:#ffc;color:#f00;', success: 'background:#cfc;color:#080;' }[c] || '';
                setTimeout(() => div.remove(), s || (container.innerText.length + t.length) * 200);
                container.appendChild(div);
            };
        })();
    </script>
    <script type="text/javascript" charset="utf-8">
        var recordingQue = {
            count:0,
            data:[]
        }
        async function feedData(arr) {
            //let sps = 333;
            //let i = 0, t = await setInterval(() => (i < arr.length && !isHold) ? data_plot.push(arr[i++]) : clearInterval(t), 1000 / sps);

            isHold || data_plot.push(...arr)
            if(isRecording){
                recordingQue.data.push(...arr);
                recordingQue.count++;
                if(!(recordingQue.count%10)){
                    logData(recordingQue.data);
                    recordingQue.data = [];
                }
            }
        }
        
        
        
        
        
        
        
        const wSocket = new WebSocket('ws://172.217.28.1:81');
        //const wSocket = new WebSocket('ws://'+location.hostname+':81');
        wSocket.binaryType = 'arraybuffer';
        wSocket.onopen = function() {
            document.notify('WebSocket: Connection established!', 'success'); wSocket.send(300);
        };
        wSocket.onmessage = function(event) {
            const data = new Uint16Array(event.data);
            let adcValues = [];
            for (let i = 0; i < data.length; i += 2) {
                let value = data[i] | (data[i + 1] << 8);
                adcValues.push((value*1.4)+1600);
            }
            feedData(adcValues,300);
        };
        wSocket.onerror = function(error) {
            document.notify('WebSocket: Error ' + error, 'error');
        };
        wSocket.onclose = function() {
            document.notify('WebSocket: Connection closed', 'warning');
        }; 
        //setInterval(() => feedData(new Array(100).fill(1840)) ,1000)
        //setInterval(() => feedData([Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,Math.random()*3000,80]) ,300)
    </script>
    
    <script type="text/javascript" charset="utf-8">
            // ---- Init ----//
            var graphCanvas = document.getElementById("ecgCanvas");
            var ctx = graphCanvas.getContext('2d');
            var scale = {x:5,y:12};//y:8.6
            var move = {x:0,y:130};//y:0
            var isHold = false;
            var isRecording = false;
            var recording = [];
            var ECGResult = [];
            
            // ---- Responsive Canvas ----//
            graphCanvas.width = graphCanvas.offsetParent.offsetWidth;
            addEventListener('resize', () => {
                graphCanvas.width = graphCanvas.offsetParent.offsetWidth;
            })
            
            
            // ---- service worker ----//
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.register("./sw.js").catch(console.log);
            }
            
            // ---- Plot Graph ----//
            function render() {
                ctx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
                
                
                // virtualCanvas
                var VC = data_plot.slice(-graphCanvas.width*scale.x-move.x,-1-move.x);
                VC = VC.map(o => {
                    return o/scale.y-move.y
                });
                
                ECGResult = ECGinterpreter(VC,500);
                
                ctx.beginPath();
                ctx.moveTo(...OLB(0, VC[0]));
                
                for(var i=0; i < VC.length;i++){
                   ctx.lineTo(...OLB(i/scale.x, VC[i]));
                }
                ctx.strokeStyle = "red";
                ctx.stroke();
                
                function OLB(x , y) {
                    // origin Left - Bottom
                    return [x , graphCanvas.height-y];
                }
                
               requestAnimationFrame(render);
            }
            setTimeout(render,100);
    </script>
    
    <script type="text/javascript" charset="utf-8">
        // --- NEVIGATION - TABS --- //
        (() => {
        const tabs = document.querySelectorAll('.tabs>button');
        const contents = document.querySelectorAll('.tab-contents>div');
    
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            tabs.forEach(t => t.removeAttribute('active'));
            contents.forEach(c => c.removeAttribute('active'));
            tab.setAttribute('active','');
            document.querySelector('.' + tab.dataset.id).setAttribute('active','');
        })})
        })();
    </script>
    
    <script type="text/javascript" charset="utf-8">
        document.getElementById("takeSnapBtn").addEventListener('click',()=>{
            const img = document.createElement('img');
            img.src = graphCanvas.toDataURL("image/png");
            img.addEventListener('click',img.remove);
            document.getElementById("snap-container").appendChild(img);
            prompt("Save SNAPSHOT As:",(name)=>{
            dbManager.add('metadata',
            {
                name: name || "SNAPSHOT",
                startTime: new Date().toISOString(),
                snapURL: img.src,
                type: "snapshot"
            })})
        });
    </script>
    
    <script type="text/javascript" charset="utf-8">
        // ---- IndexedDB Manager ----//
        class IDBManager {
            constructor({
                dbName, dbVersion, onUpgrade
            }) {
                this.dbName = dbName;
                this.dbVersion = dbVersion;
                this.onUpgrade = onUpgrade;
                this.db = null;
                this.changeEventListeners = [];
            }
        
            open() {
                if (this.db) return Promise.resolve(this.db);
        
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
        
                    request.onerror = () => reject(request.error);
                    request.onblocked = () => reject(new Error('Database upgrade blocked'));
        
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
        
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (typeof this.onUpgrade === 'function') {
                            this.onUpgrade(
                                this.db,
                                event.oldVersion,
                                event.newVersion,
                                event.target.transaction
                            );
                        }
                    };
                });
            }
        
            async add(storeName, item) {
                await this.open();
                this.changeEventListener(storeName);
                return this._executeTransaction(storeName,
                    'readwrite',
                    (store) => {
                        return store.add(item);
                });
            }
        
            async get(storeName, id) {
                await this.open();
                return this._executeTransaction(storeName,
                    'readonly',
                    (store) => {
                        return store.get(id);
                });
            }
        
            async update(storeName, id, updates) {
                await this.open();
                this.changeEventListener(storeName);
                return this._executeTransaction(storeName,
                    'readwrite',
                    async (store) => {
                        const request = await store.get(id);
                        request.onsuccess = o => {
                            var item = o.target.result;
                            Object.assign(item, updates);
                            store.put(item);
                        }
                });
            }
        
            async delete(storeName, id) {
                await this.open();
                this.changeEventListener(storeName);
                return this._executeTransaction(storeName,
                    'readwrite',
                    (store) => {
                        return store.delete(id);
                });
            }
        
            async getAll(storeName) {
                await this.open();
                return this._executeTransaction(storeName,
                    'readonly',
                    (store) => {
                        return store.getAll();
                    });
            }
        
            async clear(storeName) {
                await this.open();
                this.changeEventListener(storeName);
                return this._executeTransaction(storeName,
                    'readwrite',
                    (store) => {
                        return store.clear();
                });
            }
            changeEventListener(storeName) {
                this.changeEventListeners.forEach(o => o.storeName == storeName && o.action());
            }
            addChangeEventListener(o,sn) {
                this.changeEventListeners.push({
                    action : o,
                    storeName: sn
                });
            }
            async _executeTransaction(storeName, mode, operation) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(storeName, mode);
                    const store = transaction.objectStore(storeName);
        
                    const request = operation(store);
                    request.onerror = () => reject(request.error);
        
                    transaction.oncomplete = (e) => {
                        resolve(request.result);
                    };
                    transaction.onerror = () => reject(transaction.error);
                });
            }
        
            close() {
                if (this.db) {
                    this.db.close();
                    this.db = null;
                }
            }
        }
        
    </script>
    <script type="text/javascript" charset="utf-8">
        // ---- Manage Recording ----//
        const dbManager = new IDBManager({
            dbName: 'EcgRecordings',
            dbVersion: 1,
            onUpgrade: (db, oldVersion, newVersion, transaction) => {
                if (!db.objectStoreNames.contains('metadata')) {
                    const store = db.createObjectStore('metadata', {
                        keyPath: 'id', autoIncrement: true
                    });
                }
        
                if (!db.objectStoreNames.contains('dataChunks')) {
                    const store = db.createObjectStore('dataChunks', {
                        keyPath: 'id', autoIncrement: true
                    });
                }
            }
        });
        
        var dbVariables = {
            chunkNo: 0,
            metadataID: null,
            prevChunkID: null
        };
        
        async function startRecording(name) {
            dbVariables.metadataID = await dbManager.add('metadata',
                {
                    name: name || "RECORD",
                    startTime: new Date().toISOString(),
                    endTime: null,
                    dataChunkId: null,
                    type: "dataStream"
                });
            dbVariables.chunkNo = 0;
            dbVariables.prevChunkID = null;
            isRecording = true
        }
        
        async function logData(data) {
            dbVariables.chunkNo++;
            var currChunkID = await dbManager.add('dataChunks',
                {
                    data: data,
                    chunkNo: dbVariables.chunkNo
                });
            if (dbVariables.chunkNo == 1) {
                await dbManager.update('metadata', dbVariables.metadataID, {
                    dataChunkId: currChunkID
                });
            } else {
                await dbManager.update('dataChunks', dbVariables.prevChunkID, {
                    nextChunkId: currChunkID
                });
            }
            await dbManager.update('metadata', dbVariables.metadataID, {
                totalChunks: dbVariables.chunkNo,
                endTime: new Date().toISOString()
            })
            dbVariables.prevChunkID = currChunkID;
        }
        
        document.getElementById("recordBtn").addEventListener('click',(e) => {
            const recordBtn = e.currentTarget;
            isRecording = false
            if(recordBtn.hasAttribute("active")){
                prompt("Save RECORDING As:",startRecording,() => recordBtn.removeAttribute("active"));
            }
        })
        
        
        //dbManager.getAll('metadata').then(console.log)
        //dbManager.getAll('dataChunks').then(console.log)
        
        
        async function updateRecordingUI() {
            const metadata = await dbManager.getAll("metadata");
            const recordingsDIV = document.getElementById("recordings");
            recordingsDIV.innerText = metadata.length ? '':'NO DATA FOUND!!';
            metadata.forEach((o) => {
                const flexBox = document.createElement("div");
                flexBox.className = "flexbox";
                
                const viewBtn = document.createElement("div");
                viewBtn.innerHTML = `${o.type == "snapshot"?'&#128248;':''} ${o.name} <sub> [${o.totalChunks || '#'}]</sub> <br /><sub>${o.startTime}</sub>`; 
                viewBtn.addEventListener('click',async (e) => {
                    if(o.type == "snapshot"){
                        const img = document.createElement('img');
                        img.src = o.snapURL;
                        img.addEventListener('click',img.remove);
                        document.getElementById("snap-container").appendChild(img);
                    }
                    if(o.type == "dataStream"){
                        isHold = true;
                        data_plot = [];
                        let nextChunkID = o.dataChunkId;
                        while (nextChunkID) {
                            const chunk = await dbManager.get("dataChunks", nextChunkID);
                            if (!chunk) break;
                            data_plot.push(...chunk.data);
                            nextChunkID = chunk.nextChunkId || null;
                        }
                    }
                })
                
                const delBtn = document.createElement("div");
                delBtn.className = "danger";
                delBtn.innerHTML = "x";
                delBtn.addEventListener('click', async () => {
                    if(isRecording) {
                        //prevent delete while recording
                        document.notify("can't delete while recording!!","error")
                        return false;
                    }
                    
                    dbManager.delete("metadata",o.id);
                    
                    let nextChunkID = o.dataChunkId;
                    while (nextChunkID) {
                        const chunk = await dbManager.get("dataChunks", nextChunkID);
                        if (!chunk) break;
                        dbManager.delete("dataChunks",nextChunkID);
                        nextChunkID = chunk.nextChunkId || null;
                    }
                })
                
                const downloadBtn = document.createElement("div");
                downloadBtn.innerHTML = "&#x2913;";
                downloadBtn.addEventListener('click',() => {
                    exportData(o.id);
                })
                
                flexBox.appendChild(viewBtn);
                flexBox.appendChild(downloadBtn);
                flexBox.appendChild(delBtn);
                recordingsDIV.appendChild(flexBox);
            })
        }
        updateRecordingUI();
        dbManager.addChangeEventListener(updateRecordingUI,"metadata");
        async function exportData(id) {
            const metadata = await dbManager.get("metadata", id);
        
            let chunks = [], nextChunkID = metadata.dataChunkId;
            while (nextChunkID) {
                const chunk = await dbManager.get("dataChunks", nextChunkID);
                if (!chunk) break;
                chunks.length > 0?chunks[0].data.push(...chunk.data):chunks.push(chunk);
                nextChunkID = chunk.nextChunkId || null;
            }
            
            if(nextChunkID){
                metadata.totalChunks = 1;
                delete chunks[0].nextChunkId;
            }
        
            const blob = new Blob([JSON.stringify({ metadata, chunks })], { type: "application/json" });
            const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: "ECGREC-"+metadata.name+metadata.startTime+".json" });
            a.click();
        }
        
        document.getElementById('recordingImport').addEventListener('change', async event => {
            const reader = new FileReader();
            reader.onload = async e => {
                const { metadata, chunks } = JSON.parse(e.target.result);
                delete metadata.id;
                
                if(metadata.dataChunkId){
                    var chunk = chunks.find(o => o.id == metadata.dataChunkId);
                    delete chunk.id;
                    metadata.dataChunkId = await dbManager.add("dataChunks", chunk);
                }
                await dbManager.add("metadata", metadata);
            };
            reader.readAsText(event.target.files[0])
        });
    </script>
    
    <script type="text/javascript" charset="utf-8">
        var ECGinterpreter = (function (ecgSamples,sampleRate) {
        var result = {
            min: Math.min(...ecgSamples),
            max: Math.max(...ecgSamples),
            sps : sampleRate,
            hr: [],
            R: [],
            PQ: [],
            QR: [],
            RS: [],
            ST: []
        };
        
        // ---- Find R peaks --- //
        result.R = (input => {
            const min = result.min, mid = (result.max - min) * 0.8;
            let peaks = [], max = -Infinity, idx = -1;
            
            for (let i in input) {
                if (input[i] > min + mid) {
                    if (input[i] > max) {
                        max = input[i];
                        idx = i;
                    }
                } else if (idx !== -1) {
                    peaks.push(Number(idx));
                    max = -Infinity;
                    idx = -1;
                }
            }
            if (idx !== -1) peaks.push(Number(idx));
            return peaks;
        })(ecgSamples);
        
        
        // ---- Calculate Heart Rate --- //
        result.hr = Math.round(((result.R.length-1)*sampleRate*60)/(result.R.at(-1) - result.R[0]));
        
        // ---- Find PQST peaks --- //
        for(var i = 0; i < result.R.length-1;i++){
            var rrChunk = ecgSamples.slice(result.R[i],result.R[i+1]);
            var RS = rrChunk.indexOf(Math.min(...rrChunk));
            result.RS.push(RS);
            
            var srHalfChunk = rrChunk.slice(RS,RS+(rrChunk.length/2));
            var ST = srHalfChunk.indexOf(Math.max(...srHalfChunk));
            result.ST.push(ST);
            
            var srHalfChunk2 = rrChunk.slice(RS+(rrChunk.length/2),-1);
            var QR = 0;
            for(let k = srHalfChunk2.length - 1; k >= 0 && srHalfChunk2.at(k)-srHalfChunk2.at(k-1) >= 0; k--) QR = srHalfChunk2.length-k ;
            result.QR.push(QR);
            
            var sqHalfChunk2 = srHalfChunk2.slice(0,-QR);
            var PQ = sqHalfChunk2.length-sqHalfChunk2.indexOf(Math.max(...sqHalfChunk2));
            result.PQ.push(PQ);
        }
        //data_plot = rrChunk;
        /*data_plot[data_plot.length-QR] = 2999;
        data_plot[data_plot.length-PQ-QR] = 2999;
        data_plot[RS] = 2999;
        data_plot[RS+ST] = 2999;*/
        
        
        function analyzeECG(result) {
          if (result.hr < 5) {
            return "Rest In Peace 🕊️";
          }
          if (result.hr < 60) {
            return "Abnormal: Bradycardia";
          }
          if (result.hr > 300) {
            return "Invalid Data...!!";
          }
          if (result.hr > 100) {
            return "Abnormal: Tachycardia";
          }
          return "Normal ECG";
        }
        
        
        
        // ---- Update UI --- //
        (eles => {
            for(var i in eles){document.querySelector(i).innerText = (typeof eles[i] == 'number'?Math.round(eles[i]):eles[i]) || "•_°"
        }})
        ({
            "#param-result": analyzeECG(result),
            "#param-hr": result.hr,
            "#param-qrs": (result.QR[0] + result.RS[0])*1e3/sampleRate,
            "#param-qt": (result.QR[0] + result.RS[0] + result.ST[0])*1e3/sampleRate,
            "#param-pr": (result.PQ[0] + result.QR[0])*1e3/sampleRate,
            "#param-st": (result.ST[0])*1e3/sampleRate,
        });
        
        return result;
    });
    //let rslt = ECGinterpreter(data_plot,500);
    //console.log(JSON.stringify(rslt));
    </script>
    
    <script type="text/javascript" charset="utf-8">
        // ---- Ai Assistant ----//
        (() => {
        var isBotAlive = false;
        const botUserKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6InVzZXJfMDFKTUY3S1IwQUpHUlc3UEpTQTk0N0UwSloiLCJpYXQiOjE3Mzk5NzMwNTh9.CTDxkazNNM4NJk7sF2Vbg8xro53h61Z1IyDeMc9leKg";
        const botUserId = "user_01JMF7KR0AJGRW7PJSA947E0JZ";
        const botURL = "https://chat.botpress.cloud/49f49b18-dc9a-4e9e-abbc-a106f9190a04";
        const output = document.getElementById("ai-output");
        const requestHeader = {
            accept: 'application/json',
            'x-user-key': botUserKey,
            'content-type': 'application/json'
          };
        
        /*fetch(botURL+'/conversations/'+botUserId, {
          method: 'DELETE',
          headers: requestHeader
        }).then(res => {
            fetch(botURL+'/conversations/get-or-create', {
              method: 'POST',
              headers: requestHeader,
              body: JSON.stringify({id: botUserId})
            }).catch(err => console.error(err));
          })
          .catch(err => console.error(err));*/
        
          
          
        
        document.getElementById("ai-assistBtn").addEventListener('click',async () => {
            output.innerText = "In progress...!!";
            var prompt = ECGResult.hr > 300?"Invalid data!!":`User's heart rate is ${ECGResult.hr} BPM. Detected ECG parameters:
            P-Q duration = ${ECGResult.PQ[0] * 1000 / ECGResult.sps} ms
            Q-R duration = ${ECGResult.QR[0] * 1000 / ECGResult.sps} ms
            R-S duration = ${ECGResult.RS[0] * 1000 / ECGResult.sps} ms
            S-T duration = ${ECGResult.ST[0] * 1000 / ECGResult.sps} ms
            `;

            await fetch(botURL+'/messages', {
              method: 'POST',
              headers: requestHeader,
              body: JSON.stringify({
                payload: {type: 'text', text: prompt},
                conversationId: botUserId
              })
            }).catch(err => [document.notify("Failed to connect AI Assistant...!!","error"),output.innerText = "NO Internet Connection!!"]);
            isBotAlive || startAIListening();
        });
        async function startAIListening() {
        try {
            isBotAlive = true;
            const response = await fetch(botURL+"/conversations/"+botUserId+"/listen", {
              method: 'GET',
              headers: requestHeader
            });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                decoder.decode(value)?.match(/\{.*\}/)?.forEach(o => {
                const data = JSON.parse(o).data;
                if(data && data.payload.text){
                    data.isBot && (output.innerHTML = data.payload.text.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>"));
                }})
            }
        } catch (e) {
            isBotAlive = false;
            document.notify("AI Assistant is not responding...!!","error")
        }};
        })();
    </script>
</body>
</html>